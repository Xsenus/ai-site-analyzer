# Маршруты генерации промптов OpenAI

Этот документ описывает два вспомогательных REST‑маршрута, которые формируют готовые тексты запросов в OpenAI на основе новых требований.

## `POST /v1/prompts/site-available`

Возвращает промпт для случая, когда текст сайта успешно получен.

### Тело запроса

| Поле | Тип | Обязательность | Описание |
|------|-----|----------------|----------|
| `text_par` | string | required | Текст, собранный с сайта компании. |
| `company_name` | string | required | Название компании, используется в секции `DESCRIPTION_SCORE`. |
| `okved` | string | required | Код ОКВЭД компании, используется в секции `OKVED_SCORE`. |

### Пример запроса

```json
POST /v1/prompts/site-available
{
  "text_par": "Компания производит ...",
  "company_name": "ООО \"Пример\"",
  "okved": "25.62"
}
```

### Ответ

```json
{
  "success": true,
  "prompt": "...",
  "prompt_len": 12345,
  "started_at": "2024-03-18T09:30:25.512000",
  "finished_at": "2024-03-18T09:30:25.713000",
  "duration_ms": 201,
  "events": [
    {
      "step": "validate_input",
      "status": "success",
      "detail": "Текст сайта и атрибуты компании получены"
    },
    {
      "step": "build_prompt",
      "status": "success",
      "detail": "Сформирован промпт длиной 12345 символов"
    }
  ],
  "error": null
}
```

* `success` — признак успешной генерации. Если `false`, поле `prompt` будет `null`, а `error` заполнен текстом ошибки.
* `prompt` — полный текст, который необходимо передать в OpenAI. В шаблон уже включены разделы `DESCRIPTION`, `DESCRIPTION_SCORE`, `OKVED_SCORE`, `PRODCLASS`, `PRODCLASS_SCORE`, `EQUIPMENT_SITE`, `GOODS` и `GOODS_TYPE`, а также таблица `IB_PRODCLASS` и исходный текст сайта.
* `prompt_len` — длина промпта в символах.
* `started_at`, `finished_at` и `duration_ms` — временные метки начала, окончания и продолжительности обработки.
* `events` — хронологический список этапов обработки запроса.
* `error` — текст ошибки (если есть).

## `POST /v1/prompts/site-unavailable`

Возвращает промпт для случая, когда сайт недоступен и используется только ОКВЭД.

### Тело запроса

| Поле | Тип | Обязательность | Описание |
|------|-----|----------------|----------|
| `okved` | string | required | Код ОКВЭД компании. |

### Пример запроса

```json
POST /v1/prompts/site-unavailable
{
  "okved": "25.62"
}
```

### Ответ

```json
{
  "success": true,
  "prompt": "...",
  "prompt_len": 2150,
  "started_at": "2024-03-18T09:30:25.512000",
  "finished_at": "2024-03-18T09:30:25.600000",
  "duration_ms": 88,
  "events": [
    {
      "step": "validate_input",
      "status": "success",
      "detail": "Получен ОКВЭД компании"
    },
    {
      "step": "build_prompt",
      "status": "success",
      "detail": "Сформирован промпт длиной 2150 символов"
    }
  ],
  "error": null
}
```

Поле `prompt` содержит инструкцию OpenAI вернуть только одно число — идентификатор класса производства из справочника `IB_PRODCLASS`, который ближе всего к переданному ОКВЭД. Остальные поля аналогичны описанным выше и помогают оценить ход обработки и возможные ошибки.

Оба маршрута доступны после развёртывания приложения FastAPI и автоматически добавляются в OpenAPI‑спецификацию (Swagger UI).
